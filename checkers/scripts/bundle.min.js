function clearDrag(){$(".highlight").removeAttr("data-error");$(".highlight").removeAttr("data-tooltip");$(".highlight").removeClass("highlight")}function updateDrag(n){var t=n.target.getBoundingClientRect(),r=t.left+t.right>>1,i=t.top+t.bottom>>1,u=n.clientX<r?n.clientY<i?"top-left":"bottom-left":n.clientY<i?"top-right":"bottom-right";$(n.target).attr("data-tooltip",u)}function startDrag(n,t,i){var r;if(n.effectAllowed="move",n.setData("text",t.target.id),n.setDragImage&&(r=selectBackgroundImage(i,t.target.id),r)){var u=t.target.getBoundingClientRect(),f=t.clientX-u.left,e=t.clientY-u.top;n.setDragImage(r,f,e)}return setTimeout(function(){$(t.target).css("background-image","none")},100),!0}function getBackgroundImage(n){var t=null,i=$(n).css("background-image").match(/^url\("?(.+?)"?\)$/)[1];return i&&(t=new Image($(n).width(),$(n).height()),t.setAttribute("crossOrigin","anonymous"),t.src=i),t}function selectBackgroundImage(n,t){var r=null,i=n.getPiece(t);return i&&(r=document.getElementById(i.colorClass+"-"+i.kindClass)),r}function createDragImage(n,t){var r=$(t.target).css("background-image").match(/^url\("?(.+?)"?\)$/)[1],i;r&&(i=new Image($(t.target).width(),$(t.target).height()),i.setAttribute("crossOrigin","anonymous"),i.onload=function(){var i=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),u,r;i.width=this.width;i.height=this.height;u=i.getContext("2d");u.drawImage(this,0,0,i.width,i.height);r=new Image(i.width,i.height);r.onload=function(){var i=t.target.getBoundingClientRect(),r=t.clientX-i.left,u=t.clientY-i.top;n.setDragImage(this,r,u)};r.src=i.toDataURL("image/png")},i.src=r)}function allowedMove(n,t,i,r){var u=t.getPiece(i),f;if(u==null)return $.i18n("not-selected-piece");if(f=t.getPiece(r.id),f==null){if(u.isSelectableForJump(t)){if(!n.canJump(u,r.id))return $.i18n("illegal-jump-cell")}else if(!n.canMove(u,r.id))return $.i18n("illegal-move-cell")}else return $.i18n("occupied-cell");return null}function performMove(n,t,i,r){var u=t.getPiece(i),f;if(u==null)return $.i18n("not-selected-piece");if(f=t.getPiece(r.id),f==null)if(u.isSelectableForJump(t))if(n.tryToJump(u,r.id)){if($("#"+i).removeClass("selected"),n.selected!=null)$(r).addClass("selected");else if(n.finished)return $.i18n("game-over",n.result>0?$.i18n("player-light"):$.i18n("player-dark"))}else return $.i18n("illegal-jump-cell");else if(n.tryToMove(u,r.id))$("#"+i).removeClass("selected"),n.selected!=null&&$(r).addClass("selected");else return $.i18n("illegal-move-cell");else return $.i18n("occupied-cell");return null}function selectPiece(n,t,i){n.prepare();var r=t.getPiece(i.id);if(r==null)return $.i18n("select-piece");if(r.white!=n.whiteTurn)return $.i18n("select-player-piece",n.whiteTurn?$.i18n("player-light"):$.i18n("player-dark"));if(n.selectableForJump.length>0)if(n.selectableForJump.indexOf(i.id)>=0)n.selected=i.id,$(i).addClass("selected");else return $.i18n("select-jump-piece",n.selectableForJump);else if(r.isSelectableToMove(t))n.selected=i.id,$(i).addClass("selected");else return $.i18n("select-move-piece");return null}function subscribeToBoard(n){n.onSet(showPiece);n.onDelete(removePiece)}function unsubscribeToBoard(n){n.offSet(showPiece);n.offDelete(removePiece)}function subscribeToGame(n){n.onTurn(showTurn)}function unsubscribeToGame(n){n.offTurn(showTurn)}function showTurn(n){n?$("#panel").removeClass("black").addClass("white"):$("#panel").removeClass("white").addClass("black")}function showPiece(n,t){$("#"+t).addClass(n.colorClass).addClass(n.kindClass).attr("draggable","true")}function removePiece(n,t){$("#"+t).removeClass(n.colorClass).removeClass(n.kindClass).removeAttr("draggable")}function markupBoard(n){var t=$('<div class="last-row"/>').appendTo(n),i;for(appendLetterRow(t),i=8;i>0;i--)t=$('<div class="row"/>').appendTo(n),appendCellRow(t,i);t=$('<div class="zero-row"/>').appendTo(n);appendLetterRow(t)}function appendLetterRow(n){$('<div class="corner">&nbsp;<\/div>').appendTo(n);for(var t=97;t<105;t++)$('<div class="letter" />').appendTo(n).text(String.fromCharCode(t));$('<div class="corner">&nbsp;<\/div>').appendTo(n)}function appendCellRow(n,t){var i,r;for($('<div class="digit" />').appendTo(n).text(t),i=97;i<105;i++)r=String.fromCharCode(i)+t,$("<div />",{id:r,title:r,"class":"cell"}).appendTo(n);$('<div class="digit" />').appendTo(n).text(t)}class Cell{constructor(n,t){this.row=n;this.column=t}get cellId(){return String.fromCharCode(97+this.column)+String.fromCharCode(49+this.row)}static fromId(n){return new Cell(n.charCodeAt(1)-49,n.charCodeAt(0)-97)}}class Piece{constructor(n,t,i,r){this.kind=n;this.white=t;this.row=i;this.column=r}get colorClass(){return this.white?"white":"black"}get kindClass(){return null}canMove(){return!1}findCapture(){return null}canCapture(){return!1}isSelectableForJump(){return!1}isSelectableToMove(){return!1}move(n,t){return this.row=t.row,this.column=t.column,this}}class Man extends Piece{constructor(n,t,i){super(1,n,t,i)}get kindClass(){return"man"}canMove(n){return n.row-this.row==(this.white?1:-1)&&Math.abs(n.column-this.column)==1}findCapture(n,t){if(Math.abs(t.row-this.row)==2&&Math.abs(t.column-this.column)==2){var u=(t.row+this.row)/2,f=(t.column+this.column)/2,e=new Cell(u,f),i=e.cellId,r=n.getPiece(i);if(r!=null&&this.canCapture(r))return i}return null}canCapture(n){return this.white!=n.white&&Math.abs(n.row-this.row)==1&&Math.abs(n.column-this.column)==1}isSelectableForJump(n){var t;return this.row>1&&(this.column>1&&(t=n.getCellPiece(this.row-1,this.column-1),t!=null&&this.canCapture(t)&&n.getCellPiece(this.row-2,this.column-2)==null)||this.column<n.size-2&&(t=n.getCellPiece(this.row-1,this.column+1),t!=null&&this.canCapture(t)&&n.getCellPiece(this.row-2,this.column+2)==null))?!0:this.row<n.size-2&&(this.column>1&&(t=n.getCellPiece(this.row+1,this.column-1),t!=null&&this.canCapture(t)&&n.getCellPiece(this.row+2,this.column-2)==null)||this.column<n.size-2&&(t=n.getCellPiece(this.row+1,this.column+1),t!=null&&this.canCapture(t)&&n.getCellPiece(this.row+2,this.column+2)==null))?!0:!1}isSelectableToMove(n){if(this.white){if(this.row<n.size-1&&(this.column>0&&n.getCellPiece(this.row+1,this.column-1)==null||this.column<n.size-1&&n.getCellPiece(this.row+1,this.column+1)==null))return!0}else if(this.row>0&&(this.column>0&&n.getCellPiece(this.row-1,this.column-1)==null||this.column<n.size-1&&n.getCellPiece(this.row-1,this.column+1)==null))return!0;return!1}move(n,t){return t.row==(this.white?n.size-1:0)?new King(this.white,t.row,t.column):super.move(n,t)}}class King extends Piece{constructor(n,t,i){super(2,n,t,i)}get kindClass(){return"king"}canMove(n){return Math.abs(n.row-this.row)==Math.abs(n.column-this.column)}findCapture(n,t){var u=t.row-this.row,s=t.column-this.column,f,r,i,e,o;if(Math.abs(u)==Math.abs(s))for(f=Math.abs(u),r=new Cell(this.row,this.column),i=1;i<f;i++)if(r.row=this.row+(u>0?i:-i),r.column=this.column+(s>0?i:-i),e=r.cellId,o=n.getPiece(e),o!=null){if(i+1==f&&this.canCapture(o))return e;break}return null}canCapture(n){return this.white!=n.white&&Math.abs(n.row-this.row)==Math.abs(n.column-this.column)}isSelectableForJump(n){var r,t,i;if(this.row>1){if(this.column>1)for(r=Math.min(this.row,this.column)-1,t=1;t<r;t++)if(i=n.getCellPiece(this.row-t,this.column-t),i!=null){if(this.canCapture(i)&&n.getCellPiece(this.row-t-1,this.column-t-1)==null)return!0;break}if(this.column<n.size-2)for(r=Math.min(this.row,n.size-this.column-1)-1,t=1;t<r;t++)if(i=n.getCellPiece(this.row-t,this.column+t),i!=null){if(this.canCapture(i)&&n.getCellPiece(this.row-t-1,this.column+t+1)==null)return!0;break}}if(this.row<n.size-2){if(this.column>1)for(r=Math.min(n.size-this.row-1,this.column)-1,t=1;t<r;t++)if(i=n.getCellPiece(this.row+t,this.column-t),i!=null){if(this.canCapture(i)&&n.getCellPiece(this.row+t+1,this.column-t-1)==null)return!0;break}if(this.column<n.size-2)for(r=Math.min(n.size-this.row-1,n.size-this.column-1)-1,t=1;t<r;t++)if(i=n.getCellPiece(this.row+t,this.column+t),i!=null){if(this.canCapture(i)&&n.getCellPiece(this.row+t+1,this.column+t+1)==null)return!0;break}}return!1}isSelectableToMove(n){return this.row<n.size-1&&(this.column>0&&n.getCellPiece(this.row+1,this.column-1)==null||this.column<n.size-1&&n.getCellPiece(this.row+1,this.column+1)==null)?!0:this.row>0&&(this.column>0&&n.getCellPiece(this.row-1,this.column-1)==null||this.column<n.size-1&&n.getCellPiece(this.row-1,this.column+1)==null)?!0:!1}}class Board{constructor(n=8){this.size=n;this.position=new Map;this._onSet=new Set;this._onDelete=new Set}onSet(n){return this._onSet.add(n),this}offSet(n){return this._onSet.delete(n),this}onDelete(n){return this._onDelete.add(n),this}offDelete(n){return this._onDelete.delete(n),this}getCellPiece(n,t){var i=new Cell(n,t);return this.getPiece(i.cellId)}findSelectableForJump(n){var t=[];return this.position.forEach((i,r)=>{i.white==n&&i.isSelectableForJump(this)&&t.push(r)}),t}countPieces(n){var t=0;return this.position.forEach(i=>{i.white==n&&t++}),t}clear(){this.position.clear()}getPiece(n){return this.position.get(n)}setPiece(n,t){var i=this.position.get(n);return this.position.set(n,t),this._onSet.forEach(i=>i(t,n)),i}deletePiece(n){var t=this.position.get(n);return t!=null&&(this.position.delete(n),this._onDelete.forEach(i=>i(t,n))),t}toJSON(){var n=[];return this.position.forEach(t=>{n.push(t)}),n}}class Game{constructor(n){this.id=Math.floor(Math.random()*1e4);this.finished=!1;this.result=0;this.whiteTurn=!0;this.selected=null;this.selectableForJump=null;this.board=n;this._onTurn=new Set}onTurn(n){return this._onTurn.add(n),this}offTurn(n){return this._onTurn.delete(n),this}toggleTurn(){this.whiteTurn=!this.whiteTurn;this._onTurn.forEach(n=>n(this.whiteTurn))}prepare(){this.selectableForJump==null&&(this.selectableForJump=this.board.findSelectableForJump(this.whiteTurn))}tryToJump(n,t){var r=Cell.fromId(t),u=n.findCapture(this.board,r),i;return u!=null?(this.board.deletePiece(u),this.board.deletePiece(this.selected),i=n.move(this.board,r),this.board.setPiece(t,i),i.isSelectableForJump(this.board)?this.selected=t:(this.selected=null,this.selectableForJump=null,this.toggleTurn(),this.board.countPieces(this.whiteTurn)==0&&(this.finished=!0,this.result=this.whiteTurn?-1:1)),!0):!1}tryToMove(n,t){var i=Cell.fromId(t);return n.canMove(i)?(this.board.deletePiece(this.selected),this.board.setPiece(t,n.move(this.board,i)),this.selected=null,this.selectableForJump=null,this.toggleTurn(),!0):!1}canJump(n,t){var i=Cell.fromId(t),r=n.findCapture(this.board,i);return r!=null}canMove(n,t){var i=Cell.fromId(t);return n.canMove(i)}load(n){this.id=n.id;this.finished=n.finished;this.result=n.result;this.whiteTurn=n.whiteTurn;this.selected=n.selected;this.selectableForJump=n.selectableForJump}}class RussianCheckers{constructor(n=3){this.initRows=n}createBoard(){return new Board}setupBoard(n){for(var t,r=new Cell(0,0),i=0;i<this.initRows;i++)for(r.row=i,t=0;t<n.size;t++)(i+t&1)==0&&(r.column=t,n.setPiece(r.cellId,new Man(!0,i,t)));for(i=n.size-this.initRows;i<n.size;i++)for(r.row=i,t=0;t<n.size;t++)(i+t&1)==0&&(r.column=t,n.setPiece(r.cellId,new Man(!1,i,t)))}loadBoard(n,t=[]){var i=null,r=new Cell(0,0);t.forEach(t=>{switch(t.kind){case 1:i=new Man(t.white,t.row,t.column);break;case 2:i=new King(t.white,t.row,t.column)}i!=null&&(r.row=t.row,r.column=t.column,n.setPiece(r.cellId,i))})}createGame(n){return new Game(n)}}$(function(){var u,i,e,f,r,t,n;markupBoard($("#board"));u=null;i=document.location.protocol==="file:"?null:window.History;i&&(u=i.getState());e=function(n){if(window.URLSearchParams){var t=new URLSearchParams(document.location.search);return t.get(n)}return null};f=function(){$(".controls").i18n();$("#new").prop("title",$.i18n("new-title"));$("#save").prop("title",$.i18n("save-title"));$("#load").prop("title",$.i18n("load-title"));$("#language-label").prop("title",$.i18n("language-title"))};$.i18n({locale:"en",debug:!0});$.i18n().load({en:"i18n/messages.en.json",ru:"i18n/messages.ru.json"}).done(function(){var n=e("language");n&&($.i18n().locale=n,$("#language").val(n),document.title=$.i18n("game-title"),f());i&&i.Adapter.bind(window,"statechange",function(){var t=i.getCurrentIndex(),r=History.getState(),n;r.data.index!=t-1&&(n=e("language"),n&&($.i18n().locale=n,$("#language").val(n),f()))});$("#language").change(function(){var n=$(this).val();n&&($.i18n().locale=n,f(),i&&i.replaceState({index:i.getCurrentIndex(),language:$("#language").val()},$.i18n("game-title"),"?language="+n))})});r=new RussianCheckers;t=r.createBoard();subscribeToBoard(t);n=r.createGame(t);u&&u.data&&u.data.game?(r.loadBoard(t,u.data.game.board),n.load(u.data.game),showTurn(n.whiteTurn),n.selected!=null&&$("#"+n.selected).addClass("selected")):r.setupBoard(t);subscribeToGame(n);$(".cell").click(function(){var i=null,r;n.finished?i=$.i18n("game-over",n.result>0?$.i18n("player-light"):$.i18n("player-dark")):(r=n.selected,i=r==null?selectPiece(n,t,this):performMove(n,t,r,this));i&&alert(i)});$(".cell").on({dragstart:function(i){var r=i.originalEvent.dataTransfer,u;if(!n.finished)if(n.selected==null){if(u=selectPiece(n,t,this),u==null)return startDrag(r,i,t)}else if(n.selected==this.id)return startDrag(r,i,t);return r.effectAllowed="none",!1},dragenter:function(i){clearDrag();$(this).addClass("highlight");var r=allowedMove(n,t,n.selected,this);r?($(this).attr("data-error",r),updateDrag(i)):($(this).removeAttr("data-error"),$(this).removeAttr("data-tooltip"))},dragleave:function(){$(this).removeAttr("data-error");$(this).removeAttr("data-tooltip");$(this).removeClass("highlight")},dragend:function(){$(this).css("background-image","");clearDrag()},dragexit:function(){$(this).css("background-image","");clearDrag()},dragover:function(n){var t=n.originalEvent.dataTransfer,i=$(this).attr("data-error");return i?(t.dropEffect="none",updateDrag(n),!0):(t.dropEffect="move",n.preventDefault(),!1)},drag:function(){},drop:function(i){i.stopPropagation();i.preventDefault();$(this).removeAttr("data-error");$(this).removeAttr("data-tooltip");$(this).removeClass("highlight");var u=i.originalEvent.dataTransfer,r=performMove(n,t,u.getData("text"),this);return r&&n.finished&&alert(r),!1}});$(window).on("beforeunload",function(){i&&i.replaceState({index:i.getCurrentIndex(),language:$("#language").val(),game:n},$.i18n("game-title"),document.location.search)});$("#new").click(function(){$(".cell").removeClass("white black").removeClass("man king").removeClass("selected").removeAttr("draggable");t.clear();r.setupBoard(t);n=r.createGame(t)});$("#save").click(function(){localStorage?localStorage.setItem("checkers",JSON.stringify(n)):alert($.i18n("not-supported-storage"))});$("#load").click(function(){if(localStorage){var i=JSON.parse(localStorage.getItem("checkers"));i!=null&&($(".cell").removeClass("white black").removeClass("man king").removeClass("selected").removeAttr("draggable"),t.clear(),r.loadBoard(t,i.board),n=r.createGame(t),n.load(i),showTurn(n.whiteTurn),n.selected!=null&&$("#"+n.selected).addClass("selected"))}else alert($.i18n("not-supported-storage"))})});